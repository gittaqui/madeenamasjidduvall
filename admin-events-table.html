<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Events Table Admin</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css"/>
  <style>body{padding-top:3.5rem;} .mono{font-family:ui-monospace,monospace;font-size:.75rem;} .table-responsive{max-height:60vh;}</style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Masjid Admin</a>
      <div class="ms-auto" id="auth-box"></div>
    </div>
  </nav>
  <main class="container py-3">
    <h1 class="h4 mb-3">Events Table Management</h1>
    <p class="small text-muted">CRUD interface backed by dedicated Azure Table (<code>Events</code> or overridden by <code>EVENTS_TABLE_NAME</code>). Provides aggregated RSVP stats (on demand) and allows publishing control.</p>
    <div class="d-flex flex-wrap gap-2 mb-2">
      <button id="refreshBtn" class="btn btn-sm btn-primary">Refresh</button>
      <div class="form-check form-switch ms-3">
        <input class="form-check-input" type="checkbox" id="statsToggle">
        <label class="form-check-label small" for="statsToggle">Include RSVP Stats</label>
      </div>
    </div>
    <p class="small text-warning mb-2">Event creation disabled. To add a new event, update <code>events.json</code> (or planned site-config events section) and redeploy.</p>
    <div id="formWrapper" class="border rounded p-3 bg-light mb-3 d-none">
      <h2 class="h6 mb-3" id="formTitle">Edit Event</h2>
      <form id="eventForm" novalidate class="row g-2">
        <input type="hidden" id="eventId" />
        <div class="col-md-4">
          <label for="title" class="form-label">Title *</label>
          <input type="text" class="form-control" id="title" required maxlength="120" />
        </div>
        <div class="col-md-3">
          <label for="date" class="form-label">Date *</label>
          <input type="date" class="form-control" id="date" required />
        </div>
        <div class="col-md-2">
          <label for="time" class="form-label">Time</label>
          <input type="time" class="form-control" id="time" value="00:00" />
        </div>
        <div class="col-md-3 form-check mt-4 pt-2">
          <input class="form-check-input" type="checkbox" id="published" checked />
          <label class="form-check-label" for="published">Published</label>
        </div>
        <div class="col-12">
          <label for="image" class="form-label">Image URL</label>
          <input type="text" class="form-control" id="image" maxlength="200" />
        </div>
        <div class="col-12">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" class="form-control" rows="3" maxlength="1200"></textarea>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit" id="saveBtn">Save Changes</button>
          <button class="btn btn-secondary" type="button" id="resetBtn">Reset</button>
          <button class="btn btn-outline-secondary ms-auto" type="button" id="cancelEditBtn">Close</button>
        </div>
        <div class="col-12"><small id="formStatus" class="text-muted"></small></div>
      </form>
    </div>
    <div class="table-responsive border bg-white rounded mb-3">
      <table class="table table-sm table-hover align-middle mb-0" id="eventsTable">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Title</th><th>Date</th><th>Time</th><th>Published</th><th>Updated</th><th>RSVPs</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="small text-muted" id="statusMsg"></p>
  </main>
  <script src="/js/auth.js"></script>
  <script>
    (function(){
      const API = '/api/events';
      const tbody=document.querySelector('#eventsTable tbody');
      const statusMsg=document.getElementById('statusMsg');
    const refreshBtn=document.getElementById('refreshBtn');
  const formWrapper=document.getElementById('formWrapper');
  const form=document.getElementById('eventForm');
  const formTitle=document.getElementById('formTitle');
  const formStatus=document.getElementById('formStatus');
  const idInput=document.getElementById('eventId');
  const titleInput=document.getElementById('title');
  const dateInput=document.getElementById('date');
  const timeInput=document.getElementById('time');
  const pubInput=document.getElementById('published');
  const descInput=document.getElementById('description');
  const imgInput=document.getElementById('image');
  const resetBtn=document.getElementById('resetBtn');
  const cancelEditBtn=document.getElementById('cancelEditBtn');
      const statsToggle=document.getElementById('statsToggle');
      function esc(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
      async function load(){
        statusMsg.textContent='Loading...'; tbody.innerHTML='';
        try{
          const url=API+'?'+(statsToggle.checked?'stats=1&':'')+'_ts='+Date.now();
          const r=await fetch(url,{credentials:'include'});
          if(r.status===401){statusMsg.textContent='Unauthorized';return;}
          const d=await r.json();
          (d.items||[]).forEach(ev=>{
            const s=ev.stats||{}; const rv=`${s.total||0}/${s.confirmed||0}`;
            const tr=document.createElement('tr');
            tr.innerHTML=`<td class="mono">${esc(ev.id)}</td><td>${esc(ev.title)}</td><td>${esc(ev.date||'')}</td><td>${esc(ev.time||'')}</td><td>${ev.published?'<span class="badge bg-success">yes</span>':'<span class="badge bg-secondary">no</span>'}</td><td class="mono small">${esc(ev.updatedUtc||'')}</td><td class="small">${rv}</td><td>
              <button class="btn btn-sm btn-outline-primary" data-edit="${esc(ev.id)}">Edit</button>
              <button class="btn btn-sm btn-outline-danger" data-del="${esc(ev.id)}">Delete</button>
            </td>`;
            tbody.appendChild(tr);
          });
          statusMsg.textContent=`${d.count||0} event(s)`;
        }catch(e){ statusMsg.textContent='Error: '+e.message; }
      }
      // Creation disabled: only editing existing events is allowed.
      function openEditForm(existing){
        idInput.value=existing.id; titleInput.value=existing.title; dateInput.value=existing.date||''; timeInput.value=existing.time||'00:00'; pubInput.checked=existing.published!==false; descInput.value=existing.description||''; imgInput.value=existing.image||'';
        formTitle.textContent='Edit Event'; formStatus.textContent='Editing '+existing.id; formWrapper.classList.remove('d-none'); titleInput.focus();
      }
      async function submitForm(e){
        e.preventDefault(); formStatus.textContent='Saving...';
        if(!titleInput.value.trim() || !dateInput.value){ formStatus.textContent='Title and Date required'; return; }
  const isEdit = !!idInput.value; // must be true; creation disabled
  if(!isEdit){ formStatus.textContent='Creation disabled. Add new events via events.json.'; return; }
        const payload = {
          title: titleInput.value.trim(),
          date: dateInput.value,
          time: timeInput.value||'00:00',
          published: pubInput.checked,
          description: descInput.value.trim(),
          image: imgInput.value.trim()
        };
        if(isEdit) payload.id = idInput.value;
        const method = isEdit? 'PUT':'POST';
        try{
          const r = await fetch(API,{method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'include'});
          const d = await r.json();
          if(!r.ok){
            if(d.error==='exists') formStatus.textContent='Conflict: event already exists'; else if(d.error==='events_table_missing') formStatus.textContent='Table missing on server'; else formStatus.textContent='Error: '+(d.error||r.status);
            return;
          }
          formStatus.textContent = isEdit? 'Updated.' : (d.autoGenerated ? 'Created (auto id '+d.created+').' : 'Created.');
          if(!isEdit){ form.reset(); dateInput.value=new Date().toISOString().substring(0,10); timeInput.value='00:00'; }
          load();
        }catch(err){ formStatus.textContent='Network error'; }
      }
      form && form.addEventListener('submit', submitForm);
      resetBtn && resetBtn.addEventListener('click', ()=>{ if(!idInput.value) { form.reset(); dateInput.value=new Date().toISOString().substring(0,10); timeInput.value='00:00'; formStatus.textContent='Form cleared'; } else { openEditForm({ id:idInput.value, title:titleInput.value, date:dateInput.value, time:timeInput.value, published:pubInput.checked, description:descInput.value, image:imgInput.value }); formStatus.textContent='Reset edits'; } });
      cancelEditBtn && cancelEditBtn.addEventListener('click', ()=>{ formWrapper.classList.add('d-none'); });
      tbody.addEventListener('click', async e=>{
        if(e.target.matches('button[data-edit]')){
          const id=e.target.getAttribute('data-edit');
          const row=[...tbody.querySelectorAll('tr')].find(tr=>tr.firstChild && tr.firstChild.textContent===id);
          const existing={ id, title: row.children[1].textContent, date: row.children[2].textContent, time: row.children[3].textContent, published: /yes/.test(row.children[4].textContent) };
          openEditForm(existing);
        } else if(e.target.matches('button[data-del]')){
          const id=e.target.getAttribute('data-del');
          if(!confirm('Delete event '+id+'?')) return;
          try{ const r=await fetch(API+'?id='+encodeURIComponent(id),{method:'DELETE', credentials:'include'}); if(!r.ok){ alert('Delete failed'); } else { load(); } }catch{ alert('Delete error'); }
        }
      });
  // New Event button removed (creation disabled)
      refreshBtn.addEventListener('click', load);
      statsToggle.addEventListener('change', load);
      load();
    })();
  </script>
</body>
</html>